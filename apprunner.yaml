version: 1.0
runtime: nodejs20
build:
  commands:
    pre-build:
      # Install dependencies
      - npm ci
    build:
      # Build the Next.js application
      - npm run build
    post-build:
      # Initialize database and run migrations
      # This will create the migration table if it doesn't exist
      # and apply any pending migrations
      - npm run db:init || true
      - npm run migrate

run:
  runtime-version: 20
  command: npm start
  network:
    port: 3000
    env: APP_PORT
  env:
    - name: NODE_ENV
      value: "production"
    # The following environment variables should be configured in App Runner console:
    # - DSQL_HOSTNAME (your Aurora DSQL cluster endpoint)
    # - DSQL_REGION (AWS region of your DSQL cluster)
    # - DSQL_DATABASE (database name, typically 'postgres')

  # Health check configuration
  # App Runner will ping this endpoint to verify the service is healthy
  # Uncomment and customize if you add a health check endpoint
  # healthcheck:
  #   protocol: http
  #   path: /api/health
  #   interval: 10
  #   timeout: 5
  #   healthy-threshold: 1
  #   unhealthy-threshold: 5
